# ArgoCD Application for Observability Components
# Story 1.6: Create ArgoCD Applications for Observability and Namespaces
# Manages: Splunk Connect for Kubernetes, New Relic APM (deployed in Epic 7)

apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: observability
  namespace: argocd
  labels:
    app.kubernetes.io/name: observability
    app.kubernetes.io/part-of: odp-platform
  annotations:
    argocd.argoproj.io/sync-wave: "3"  # Deploy after platform-core (wave 2)
spec:
  # Project reference (default for now, custom projects in Epic 2)
  project: default

  # Source: GitOps repository
  source:
    repoURL: https://github.com/mokhahmed92/odp-platform-gitops
    targetRevision: main
    path: observability

    # Directory-level settings (applies to all Helm charts in observability/)
    directory:
      recurse: true  # Process subdirectories (splunk-connect/, newrelic/)

  # Destination: Kubernetes cluster and namespace
  destination:
    server: https://kubernetes.default.svc
    namespace: odp-observability  # Isolated namespace for monitoring/logging

  # Sync Policy: Automated with prune and selfHeal
  syncPolicy:
    automated:
      prune: true      # Delete resources not in Git
      selfHeal: true   # Revert manual changes back to Git state
      allowEmpty: true # Allow syncing when directory is empty (pre-Epic 7)

    syncOptions:
      - CreateNamespace=true  # Auto-create odp-observability namespace
      - PrunePropagationPolicy=foreground  # Delete dependents before owner
      - PruneLast=true  # Prune after all resources synced (safer)

    retry:
      limit: 5  # Retry failed syncs up to 5 times
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m

  # Ignore specific differences (prevent unnecessary syncs)
  ignoreDifferences:
    - group: apps
      kind: Deployment
      jsonPointers:
        - /spec/replicas  # Ignore replica count changes (HPA may modify)
